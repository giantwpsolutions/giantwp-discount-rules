<script setup>
import { onMounted, ref } from "vue";
import { QuestionMarkCircleIcon } from "@heroicons/vue/24/solid";
import {
  licenseKey,
  licenseStatus,
  isLoadingLicense,
  fetchLicenseStatus,
  activateLicense,
  deactivateLicense,
} from "@/data/save-data/licenseApi";

import {
  saveSettingsData,
  loadSettings,
  saveSettings,
  isLoadingSettings,
} from "@/data/save-data/saveSettingsData";

import { settingsUpdate, errorMessage } from "@/data/message.js";

const { __ } = wp.i18n;

const isProActive = ref(false);

onMounted(() => {
  isProActive.value = !!pluginData?.proActive;

  if (isProActive.value) {
    fetchLicenseStatus();
    loadSettings();
  }
});

const handleAction = async () => {
  if (licenseStatus.value === "valid") {
    await deactivateLicense();
  } else {
    await activateLicense(licenseKey.value);
  }
};

const handleSaveSettings = async () => {
  try {
    await saveSettings();
    settingsUpdate();
  } catch (error) {
    errorMessage();
  }
};
</script>

<template>
  <div
    class="tw-bg-white tw-rounded-[10px] tw-min-h-[250px] tw-border tw-border-gray-300 tw-p-6 tw-flex tw-flex-col">
    <h4 class="tw-text-xl tw-font-bold tw-mb-6">
      {{ __("Settings", "giantwp-discount-rules") }}
    </h4>

    <!-- License -->
    <div v-if="isProActive">
      <div class="tw-w-full tw-max-w-2xl tw-flex tw-items-center tw-mb-2 tw-gap-3">
        <label class="tw-text-base tw-font-medium tw-text-dark tw-w-32">
          {{ __("License Key", "giantwp-discount-rules") }}
        </label>

        <el-input
          v-model="licenseKey"
          style="width: 300px"
          :placeholder="__('Enter License Key', 'giantwp-discount-rules')" />

        <el-button
          :type="licenseStatus === 'valid' ? 'danger' : 'primary'"
          :loading="isLoadingLicense"
          @click="handleAction">
          {{
            licenseStatus === "valid"
              ? __("Deactivate", "giantwp-discount-rules")
              : __("Activate", "giantwp-discount-rules")
          }}
        </el-button>
      </div>

      <div
        v-if="licenseStatus !== 'unknown'"
        class="tw-pl-32 tw-text-sm tw-mt-1 tw-text-gray-700">
        <template v-if="licenseStatus === 'valid'">
          ✅ {{ __("Your license is active", "giantwp-discount-rules") }}
        </template>
        <template v-else>
          ❌
          {{ __("License is invalid or expired", "giantwp-discount-rules") }}
        </template>
      </div>
    </div>

    <!-- General Settings -->
    <div class="tw-mt-6">
      <!-- Discount Based On -->
      <div class="tw-w-full tw-max-w-2xl tw-flex tw-items-center tw-mb-6 tw-gap-3">
        <label class="tw-text-base tw-font-medium tw-text-dark tw-w-32">
          {{ __("Rule Apply on", "giantwp-discount-rules") }}
        </label>

        <el-select
          v-model="saveSettingsData.discountBasedOn"
          size="default"
          style="width: 240px"
          popper-class="custom-dropdown">
          <el-option
            :value="'regular_price'"
            :label="__('Regular Price', 'giantwp-discount-rules')" />
          <el-option
            :value="'sale_price'"
            :label="__('Sale Price', 'giantwp-discount-rules')" />
        </el-select>
      </div>

      <!-- Order Page Label -->
      <div class="tw-w-full tw-max-w-2xl tw-flex tw-items-center tw-mb-6 tw-gap-3">
        <label
          class="tw-text-base tw-font-medium tw-text-dark tw-w-32 tw-flex tw-items-center tw-gap-2">
          {{ __("Order Label", "giantwp-discount-rules") }}
          <div class="tw-group tw-relative">
            <el-tooltip
              class="box-item"
              effect="dark"
              :content="
                __(
                  'Show a label on admin order page if discount applied',
                  'giantwp-discount-rules'
                )
              "
              placement="top"
              popper-class="custom-tooltip">
              <QuestionMarkCircleIcon
                class="tw-w-4 tw-h-4 tw-text-gray-500 tw-hover:text-gray-700 tw-cursor-pointer" />
            </el-tooltip>
          </div>
        </label>

        <el-switch
          v-model="saveSettingsData.orderPageLabel"
          inline-prompt
          :active-text="__('On', 'giantwp-discount-rules')"
          :inactive-text="__('Off', 'giantwp-discount-rules')" />
      </div>
          <!-- Upsell Notification Widget -->
        <div class="tw-w-full tw-max-w-2xl tw-flex tw-items-center tw-mb-6 tw-gap-3">
        <label
          class="tw-text-base tw-font-medium tw-text-dark tw-w-32 tw-flex tw-items-center tw-gap-2">
          {{ __("Upsell Notification", "giantwp-discount-rules") }}
          <div class="tw-group tw-relative">
            <el-tooltip
              class="box-item"
              effect="dark"
              :content="
                __(
                  'Show a small notification at the bottom for upsell',
                  'giantwp-discount-rules'
                )
              "
              placement="top"
              popper-class="custom-tooltip">
              <QuestionMarkCircleIcon
                class="tw-w-4 tw-h-4 tw-text-gray-500 tw-hover:text-gray-700 tw-cursor-pointer" />
            </el-tooltip>
          </div>
        </label>

        <el-switch
          v-model="saveSettingsData.upsellNotificationWidget"
          inline-prompt
          :active-text="__('On', 'giantwp-discount-rules')"
          :inactive-text="__('Off', 'giantwp-discount-rules')" />
      </div>


      

      <!-- Save Settings Button -->
      <div class="tw-mt-4">
        <el-button
          type="primary"
          :loading="isLoadingSettings"
          @click="handleSaveSettings">
          {{ __("Save Settings", "giantwp-discount-rules") }}
        </el-button>
      </div>
    </div>
  </div>
</template>
